# Project Scheduler - Планировщик проектов

JavaScript-решение для автоматического составления графика выполнения задач и операций проекта исполнителями с учётом рабочего времени, обеденных перерывов и зависимостей между задачами.

## Описание

Система автоматически:
- Очищает данные проекта перед планированием (опционально)
- Загружает данные проекта и шаблона через API
- Рассчитывает длительность задач/операций на основе шаблонных нормативов × количество
- Сохраняет рассчитанную длительность в систему
- Планирует время начала задач/операций с учётом:
  - Рабочего времени (по умолчанию 9:00-18:00)
  - Обеденного перерыва (по умолчанию 13:00-14:00, 1 час)
  - Зависимостей между задачами и операциями
  - Ограничения: задачи длительностью ≤ 4 часов не разбиваются на разные дни
- Сохраняет время начала в систему
- Отображает график в виде таблицы

## Файлы проекта

- **project-scheduler.js** - основной скрипт планировщика
- **project-workspace.js** - скрипт рабочего места для управления проектами
- **test-scheduler.js** - набор тестов для проверки корректности работы
- **demo.html** - демо-страница с инструкциями по использованию планировщика
- **workspace-demo.html** - демо-страница рабочего места управления проектами
- **Результаты запросов по API.txt** - примеры ответов API для тестирования

## Использование

### Рабочее место управления проектами (project-workspace.js)

1. Разместите скрипт на странице системы integram.io:

```html
<div class="content"></div>
<script src="project-workspace.js"></script>
```

2. Убедитесь, что на странице доступны глобальные переменные:
   - `db` - имя текущей базы данных
   - `xsrf` - токен XSRF для POST-запросов

3. Скрипт автоматически:
   - Загрузит и отобразит список проектов в статусе "В работе"
   - Позволит просмотреть план выполнения каждого проекта
   - Предоставит кнопки для очистки планирования и перехода к планированию

#### Возможности рабочего места

- **Список проектов**: Таблица со всеми активными проектами (Проект | Заказчик | Старт | Срок | Объект)
- **Просмотр деталей**: Кнопка "Посмотреть" открывает план выполнения задач проекта
- **Очистка планирования**: Кнопка для очистки всех дат, длительностей и назначений исполнителей
- **Планирование**: Кнопка для перехода на страницу планирования проекта

### Планировщик проектов (project-scheduler.js)

1. Разместите скрипт на странице системы integram.io:

```html
<div class="content"></div>
<script src="project-scheduler.js"></script>
```

2. Убедитесь, что на странице доступны глобальные переменные:
   - `db` - имя текущей базы данных
   - `xsrf` - токен XSRF для POST-запросов

3. Скрипт автоматически:
   - Загрузит данные проекта
   - Рассчитает длительности
   - Составит график
   - Сохранит результаты в систему
   - Отобразит таблицу с графиком

### Конфигурация

Параметры в начале файла `project-scheduler.js`:

```javascript
const CONFIG = {
    // API endpoints
    projectReportId: 2681,           // ID отчёта с данными проекта
    workHoursReportId: 3283,         // ID отчёта с настройками рабочего времени
    parametersReportId: 3248,        // ID отчёта со справочником параметров
    executorsReportId: 2777,         // ID отчёта со списком исполнителей
    cleanupReportId: 2310,           // ID отчёта для очистки данных проекта

    // Field codes for saving data
    taskDurationCode: 't3758',       // Код параметра длительности задачи
    operationDurationCode: 't3757',  // Код параметра длительности операции
    taskStartCode: 't798',           // Код параметра времени начала задачи
    operationStartCode: 't2665',     // Код параметра времени начала операции
    taskExecutorCode: 't690',        // Код параметра исполнителя задачи
    operationExecutorCode: 't2399',  // Код параметра исполнителя операции

    // Default values
    defaultDuration: 60,             // Длительность по умолчанию (60 минут)
    lunchDuration: 60,               // Длительность обеда (1 час = 60 минут)

    // Cleanup options
    enableCleanup: true,             // Включить очистку данных перед планированием
};
```

## Очистка данных проекта

Перед запуском планирования система может автоматически очистить данные проекта, удаляя:
- Все даты начала задач и операций
- Все рассчитанные длительности
- Все назначения исполнителей

### Как использовать

Функция очистки управляется параметром `enableCleanup` в конфигурации:

```javascript
const CONFIG = {
    enableCleanup: true,  // Включить очистку (рекомендуется)
    // или
    enableCleanup: false, // Отключить очистку
};
```

### Принцип работы

1. Система загружает данные проекта
2. Определяет ID активного проекта (со статусом "В работе")
3. Если `enableCleanup: true`, вызывает отчёт 2310 с параметром `FR_ProjID={ID проекта}`
4. Повторно загружает данные проекта после очистки
5. Продолжает планирование с чистыми данными

### URL очистки

```
https://{host}/{db}/report/2310?FR_ProjID={ID проекта}
```

Этот отчёт должен быть настроен в системе integram.io для очистки полей проекта.

## API

### Endpoints

#### 1. Очистка данных проекта
```
GET https://{host}/{db}/report/2310?FR_ProjID={ID проекта}
```
Очищает все даты, длительности и назначения исполнителей для указанного проекта.

#### 2. Данные проекта
```
GET https://{host}/{db}/report/2681?JSON_KV
```
Возвращает список задач и операций проекта и шаблона.

#### 3. Настройки рабочего времени
```
GET https://{host}/{db}/report/3283?JSON_KV
```
Возвращает конфигурацию рабочего дня:
- `day_start` - начало рабочего дня (час)
- `day_end` - конец рабочего дня (час)
- `lunch_start` - начало обеденного перерыва (час)

#### 4. Сохранение данных
```
POST https://{host}/{db}/_m_set/{itemId}?JSON=1
Content-Type: application/x-www-form-urlencoded

{fieldCode}={value}&_xsrf={token}
```

Коды полей:
- Длительность задачи: `t3094`
- Длительность операции: `t704`
- Время начала задачи: `t798`
- Время начала операции: `t2665`

## Алгоритм работы

### 1. Расчёт длительности

Приоритет источников (в порядке убывания):

1. **Существующий норматив** - если в проекте уже указана длительность > 0
2. **Норматив из шаблона × количество** - берётся норматив из шаблонного проекта и умножается на количество
3. **Значение по умолчанию** - если норматив не найден в шаблоне (60 минут)

#### Обработка количества:
- Если `Кол-во` пустое, не указано или равно 0 → считается = 1
- Если `Кол-во` содержит нечисловое значение → считается = 1

### 2. Планирование времени

Алгоритм учитывает:

- **Последовательность выполнения** - задачи в данных упорядочены по последовательности
- **Зависимости** - если указана "Предыдущая Операция" или "Предыдущая Задача", начало планируется не раньше завершения предыдущей
- **Рабочее время** - планирование только в пределах рабочего дня
- **Обеденный перерыв** - автоматически учитывается и пропускается
- **Короткие задачи** - задачи длительностью ≤ 4 часов не разбиваются на разные дни

### 3. Форматы данных

#### Дата (например, Старт проекта):
```
dd.mm.yyyy
Пример: 20.11.2025
```

#### Дата и время (например, время начала):
```
dd.mm.yyyy HH:MM:SS
Пример: 29.11.2025 17:39:00
```

## Тестирование

### Запуск тестов

```bash
node test-scheduler.js
```

### Тестовое покрытие

**Тест 1: Нормативы**
- ✓ Задача без норматива получает норматив из шаблона
- ✓ Операция без норматива получает норматив из шаблона
- ✓ Умножение на количество работает корректно
- ✓ Существующие нормативы не перезаписываются

**Тест 2: Время**
- ✓ Дата старта проекта парсится корректно
- ✓ Время не назначается на нерабочие часы
- ✓ Обеденный перерыв учитывается
- ✓ Зависимости между задачами соблюдаются

**Тест 3: Отображение**
- ✓ В таблице нет NaN или undefined
- ✓ Даты отображаются в читаемом формате
- ✓ Длительность рассчитывается корректно
- ✓ Статусы нормативов понятны

## Пример вывода

Скрипт создаёт таблицу с колонками:

| № | Задача | Операция | Длительность (мин) | Источник норматива | Количество | Время начала | Время окончания | Зависимость от |
|---|--------|----------|-------------------|-------------------|------------|--------------|----------------|----------------|
| 1 | Проверка документации | Проверка доков на полноту и качество | 120 | Шаблон | 1 | 20.11.2025 09:00:00 | 20.11.2025 11:00:00 | - |
| 2 | Проверка документации | Обработка документации от заказчика | 480 | Шаблон | 2 | 20.11.2025 11:00:00 | 20.11.2025 18:00:00 | Проверка доков... |

## Структура данных

### Проект "В работе"
```json
{
  "ПроектID": "2614",
  "Проект": "Установка витражей СПК (ОПЕРАЦИИ)",
  "Старт": "20.11.2025",
  "Задача проектаID": "2615",
  "Задача проекта": "Проверка документации",
  "Операция": "Проверка доков на полноту и качество",
  "ОперацияID": "2632",
  "Норматив операции": "",
  "Кол-во": "",
  "Предыдущая Операция": "",
  "Шаблон Проекта (Проект)": "2326",
  "Статус проекта": "В работе",
  "Длительность операции": ""
}
```

### Шаблонный проект
```json
{
  "ПроектID": "2326",
  "Проект": "Шаблон. Установка витражей СПК (ОПЕРАЦИИ)",
  "Задача проектаID": "2327",
  "Задача проекта": "Проверка документации",
  "Операция": "Проверка доков на полноту и качество",
  "ОперацияID": "2347",
  "Норматив операции": "120",
  "Кол-во": "",
  "Предыдущая Операция": "",
  "Статус проекта": ""
}
```

## Требования

- Современный браузер с поддержкой ES6+
- Доступ к API системы integram.io
- Глобальные переменные `db` и `xsrf` на странице

## Особенности реализации

### Работа с ключами данных
Все ключи с пробелами и кириллицей обрабатываются через квадратные скобки:
```javascript
item['Задача проекта']
item['Норматив операции']
```

### Обработка рабочего времени
Функция `addWorkingTime()` корректно обрабатывает:
- Переходы через обеденный перерыв
- Переходы на следующий день
- Начало работы до/после рабочего времени

### Обработка зависимостей
Система отслеживает время завершения каждой задачи/операции в Map-структуре для быстрого доступа при проверке зависимостей.

## Решение проблем

### Скрипт не запускается
- Проверьте наличие глобальных переменных `db` и `xsrf`
- Проверьте доступность div с классом `content`
- Откройте консоль браузера для просмотра ошибок

### Неверные длительности
- Проверьте данные шаблонного проекта
- Убедитесь, что нормативы указаны в минутах
- Проверьте значения в поле `Кол-во`

### Неверное время начала
- Проверьте настройки рабочего времени в отчёте 3283
- Убедитесь, что дата старта проекта указана корректно
- Проверьте зависимости между задачами

## Лицензия

Этот проект разработан для системы integram.io/orbits.

## Рабочее место управления проектами

### Описание

Рабочее место предоставляет интерфейс для управления проектами в статусе "В работе" (ID статуса: 810).

### Функциональность

1. **Список активных проектов**
   - Автоматическая загрузка всех проектов со статусом "В работе"
   - Отображение в виде таблицы с колонками: Проект | Заказчик | Старт | Срок | Объект
   - Кнопка "Посмотреть" для каждого проекта

2. **План выполнения задач**
   - Детальная таблица с задачами и операциями проекта
   - Отображение нормативов и фактических длительностей
   - Даты начала задач и операций
   - Информация о захватках (координатах)

3. **Управление планированием**
   - **Кнопка "Очистить планирование"**:
     - Вызывает отчет 2310 для очистки данных проекта
     - Становится неактивной на время выполнения
     - Запрашивает подтверждение перед выполнением
     - Автоматически обновляет данные после очистки

   - **Кнопка "Планировать"**:
     - Переходит на страницу планирования: `https://{host}/{db}/assignment?FR_ProjID={ID}`
     - Сохраняет ID проекта в параметре URL

### Конфигурация workspace

```javascript
const CONFIG = {
    // API endpoints
    projectListReportId: 4363,      // Список проектов с фильтрацией
    executionPlanReportId: 4363,    // План выполнения конкретного проекта
    cleanupReportId: 2310,          // Очистка данных проекта

    // Status ID для фильтрации
    activeStatusId: 810,            // Статус "В работе"
};
```

### API Endpoints для рабочего места

#### 1. Получение списка проектов
```
GET https://{host}/{db}/report/4363?JSON_KV
```
Возвращает все проекты. Фильтрация по статусу "В работе" происходит на клиенте.

#### 2. Получение плана выполнения
```
GET https://{host}/{db}/report/4363?FR_ПроектID={ID}&JSON_KV
```
Возвращает детальный план с задачами, операциями, нормативами и длительностями для конкретного проекта.

#### 3. Очистка планирования
```
GET https://{host}/{db}/report/2310?FR_ProjID={ID}
```
Очищает все планирование проекта (даты, длительности, назначения исполнителей).

#### 4. Переход к планированию
```
https://{host}/{db}/assignment?FR_ProjID={ID}
```
URL для перехода на страницу автоматического планирования проекта.

### Пример интеграции

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление проектами</title>
</head>
<body>
    <!-- Контейнер для рабочего места -->
    <div class="content"></div>

    <!-- Глобальные переменные (предоставляются системой integram.io) -->
    <script>
        window.db = 'orbits';           // Имя базы данных
        window.xsrf = 'token-value';     // XSRF токен
    </script>

    <!-- Подключение скрипта рабочего места -->
    <script src="project-workspace.js"></script>
</body>
</html>
```

### Безопасность

- Все пользовательские данные экранируются через функцию `escapeHtml()` для предотвращения XSS-атак
- Кнопка очистки требует подтверждения от пользователя
- Кнопка очистки блокируется на время выполнения запроса

### Обработка ошибок

- Все ошибки логируются в консоль браузера с префиксом `[Workspace]`
- При ошибках загрузки данных отображается уведомление пользователю
- При ошибках очистки кнопка разблокируется для повторной попытки

## Связанные ссылки

- [Issue #1](https://github.com/ideav/orbits/issues/1) - исходное задание планировщика
- [Pull Request #2](https://github.com/ideav/orbits/pull/2) - реализация планировщика
- [Issue #38](https://github.com/ideav/orbits/issues/38) - рабочее место управления проектами
- [Pull Request #39](https://github.com/ideav/orbits/pull/39) - реализация рабочего места
